<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login | Moniepoint Clone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #loader {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    /* Smooth floating animation */
    @keyframes floatUp {
      0% { transform: translateY(40px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    .float-in {
      animation: floatUp 0.8s ease-out forwards;
    }

    @media (max-width: 768px) {
      .form-bg {
        background-image: url('{{ url_for("static", filename="images/zodi.png") }}');
        background-size: cover;
        background-position: center;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 via-white to-green-100 flex items-center justify-center min-h-screen p-4">

  <!-- Loader -->
  <div id="loader" class="flex">
    <img src="{{ url_for('static', filename='images/tom-walking.gif') }}" alt="Loading..." class="w-12 h-12">
  </div>

  <!-- Main Container -->
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col md:flex-row overflow-hidden transform float-in">

    <!-- Left Image (desktop only) -->
    <div class="hidden md:block md:w-1/2">
      <img src="{{ url_for('static', filename='images/zodi2.png') }}" alt="Side Image" class="h-full w-full object-cover">
    </div>

    <!-- Login Form -->
    <div class="w-full md:w-1/2 flex flex-col justify-center form-bg p-6 sm:p-10">
      
      <!-- Welcome Text -->
      <div class="mb-6 text-center md:text-left">
        <h1 class="text-3xl font-extrabold text-green-700 mb-2">Welcome Back</h1>
        <p class="text-gray-600 text-sm sm:text-base">Enter your credentials to access your account</p>
      </div>

      <!-- User/Merchant Toggle -->
      <div class="flex justify-center md:justify-start mb-6 space-x-4">
        <button class="px-4 py-2 rounded bg-green-700 text-white font-semibold hover:bg-green-800 shadow-md transition">User</button>
        <button class="px-4 py-2 rounded border border-gray-300 text-gray-800 font-semibold hover:bg-gray-100 transition">Merchant</button>
      </div>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="mb-4">
            {% for category, message in messages %}
              <li class="text-{{ 'red' if category == 'danger' else 'green' }}-600 mb-2 text-sm">{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <!-- Login Form -->
      <form method="POST" onsubmit="showLoader()" class="space-y-4">
        <input type="email" name="email" placeholder="Email (M@example.com)" 
          class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 shadow-sm text-sm sm:text-base" required>
        
        <input type="password" name="password" placeholder="Password" 
          class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 shadow-sm text-sm sm:text-base" required>

        <!-- Remember Me & Forgot -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between text-sm gap-2">
          <label class="flex items-center space-x-2 text-gray-700">
            <input id="rememberMe" type="checkbox" class="h-4 w-4 text-green-700 border-gray-300 rounded">
            <span>Remember Me</span>
          </label>
          <a href="#" class="text-green-700 hover:underline">Forgot password?</a>
        </div>

        <button type="submit" 
          class="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 shadow-lg transition text-sm sm:text-base">
          Login
        </button>
      </form>

      <!-- Fingerprint Login -->
      <div class="flex justify-center mt-6">
        <button id="fingerprintBtn" 
          class="flex items-center bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold transition shadow-sm text-sm sm:text-base">
          <img src="{{ url_for('static', filename='images/finger.png') }}" alt="Fingerprint" class="w-6 h-6 mr-2">
          Login with Fingerprint
        </button>
      </div>

      <!-- Signup Link -->
      <p class="mt-6 text-center text-gray-600 text-sm sm:text-base">Don't have an account? 
        <a href="{{ url_for('signup') }}" class="text-green-700 font-bold hover:underline">Sign Up</a>
      </p>
    </div>
  </div>

  <script>
    function showLoader() {
      document.getElementById('loader').style.display = 'flex';
    }

    async function fingerprintLogin() {
      showLoader();
      try {
        const resp = await fetch("/webauthn/begin_login", { method: "POST" });
        const options = await resp.json();

        options.challenge = Uint8Array.from(atob(options.challenge), c => c.charCodeAt(0));
        options.allowCredentials.forEach(cred => {
          cred.id = Uint8Array.from(atob(cred.id), c => c.charCodeAt(0));
        });

        const assertion = await navigator.credentials.get({ publicKey: options });

        const authData = {
          id: assertion.id,
          rawId: btoa(String.fromCharCode(...new Uint8Array(assertion.rawId))),
          type: assertion.type,
          response: {
            authenticatorData: btoa(String.fromCharCode(...new Uint8Array(assertion.response.authenticatorData))),
            clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(assertion.response.clientDataJSON))),
            signature: btoa(String.fromCharCode(...new Uint8Array(assertion.response.signature))),
            userHandle: assertion.response.userHandle ? btoa(String.fromCharCode(...new Uint8Array(assertion.response.userHandle))) : null
          }
        };

        const verifyResp = await fetch("/webauthn/verify_login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(authData)
        });

        const result = await verifyResp.json();
        if (result.success) {
          window.location.href = "/dashboard";
        } else {
          alert("Fingerprint login failed!");
          document.getElementById('loader').style.display = 'none';
        }
      } catch (err) {
        console.error(err);
        alert("Fingerprint login not available or failed.");
        document.getElementById('loader').style.display = 'none';
      }
    }

    document.getElementById("fingerprintBtn").addEventListener("click", fingerprintLogin);
  </script>
</body>
</html>
